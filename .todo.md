# 待办

## 工具链
- [ ] 增加一键将任意图片转换为屏幕分辨率且符合FC配色的工具

## 对话框系统
- [x] 菜单支持翻页
- [x] GenericDialogue也需要支持MCP
- [x] GenericDialogue的选项应该靠左,靠上
- [x] 第一章穿好装备返回，需要点触发后才出后续剧情
- [x] MenuOptionList选项用RichTextLabel支持BBCode并隐藏滚动自适应

## 背景系统
- [ ] 增加显示/隐藏背景图片的系统

## 战斗系统
- [x] await 战斗可以得到bool值: 胜利/失败
- [ ] 增加战斗中的教程
- [x] AI更随机
- [x] 只有一个敌人时跳过选择敌人的过程
- [ ] 选择目标时hover的目标角色卡片应该展开
- [x] 角色卡片展开后右腿被cull掉了
- [x] 装备越重,行动力增长越慢
- [x] 菜单选项取消打字机效果
- [x] 回合开始的主菜单不应提供返回选项
- [x] 每个攻击行动自己计算到各个object的DodgeImpact/BlockImpact。例如用头槌攻击脚几乎是100%被格挡/闪避的，用脚给头格挡也几乎是不可能成功的
- [ ] 攻击结算按多层护甲逐层判定命中(外层-中层-内层)
- [x] 格挡成功时结算被格挡部位的伤害
- [x] 攻击命中时结算对应部位的伤害
- [ ] 砍伤命中护甲时附加流血效果

## 身体部位血量系统
- [x] BodyPart增加public readonly BodyPartCode id 字段
- [x] 定义ICombatTarget接口并为角色、身体部位提供实现
- [x] 改造玩家与AI攻击决策流程以选择ICombatTarget
- [x] 需要可以返回的MenuDialogue.CreateDialogue增加参数,是否可以Esc返回.
- [x] 有esc时,自动追加选项"返回"
- [x] 选择返回或者esc会await得到对应下标
- [x] 攻击目标的身体部位菜单支持返回
- [x] 攻击选择目标角色的菜单需要支持返回
- [x] 在Combat结算中使用部位血量并同步日志与动画
- [x] 以头部或躯干血量归零作为死亡判定来源
- [x] 移除角色全局 `HP` 字段
- [x] 调整 `CharacterNode` 血量展示为头部/躯干最低百分比
- [x] 巡检UI与战斗流程确保不再出现旧 `HP` 引用
- [x] CharacterNode需要能够展开
- [x] CharacterNode增加Expanded属性
- [x] 增加每个身体部位的血条
- [x] 展开后隐藏Overview
- [x] CharacterNode在攻击/受击时展开
- [ ] 血条改为分数。不同部位用不同的最大血量
- [x] 身体部位增加腹股沟

## 装备系统
- [x] 定义装备类型enum(mask)
- [x] 定义装备类,实现ICombatTarget
- [x] 定义装备槽接口.装备槽可以放装备(可能嵌套)
- [x] 初始角色直接装备一把剑用来测试
- [x] 选择攻击目标时可以选择敌人手上的武器
- [x] 定义物品栏
- [x] 实现装备交互
- [x] 战斗中可以抽出装备在皮带上的武器
- [x] 没有装备槽的部位不应该出现在装备菜单里
- [x] 装备槽的desc需要显示可以放入物品的类型
- [x] 装备的desc第一行显示他的flag,第二行才显示其他属性
- [x] 穿装备时,位置不匹配的装备不要出现
- [x] 物品槽需要引用他的Container
- [x] 进入战斗时物品需要记住它属于哪个槽.退出战斗时,如果槽从属的Container还在人身上,那么就回到这个槽
- [x] 角色的手臂第0槽为护甲,第1槽为武器且装备菜单隐藏武器槽(只能战斗中拿出)
- [x] 剧情选项可以提前拿出武器
- [x] 定义装备属性
- [ ] 接入excel
- [x] 优化槽位显示 `槽位1: 板甲` -> `#板甲` `槽位2: 空` -> `#空`
- [x] 队伍中只有一个人时,查看装备不要选择角色了
- [x] 简化装备(去掉内层,中层,外层.合并为躯干护甲)
- [x] 增加棉裤,链甲裤(换个好听的名字吧),板甲护腿. 增加装备掩码: 裤子(换个好听的名字吧但是我想不到),护腿
- [x] 装备菜单选择身体部位名应该带有装备.例如`右臂[护手][长剑]`
- [x] 装备菜单选择装备槽时,装备槽上有装备且装备上有装备,应该显示装备上的装备
- [x] ItemConfig定义时使用Story字段, Description展示关键数值(武器伤害/护甲防护等)+Story
- [x] 开局物品改为长剑、绵甲、棉裤、皮带，绵甲棉裤皮带开局即穿戴，首个任务改成只要求装备长剑
- [x] 打开装备菜单时标题改为“查看装备”
- [x] 查看装备的各级菜单标题使用导航格式，例如`躯干>皮带`
- [x] 移除"丢弃"行动
- [x] 定义护甲的覆盖率。这会影响到武器打在肉上还是护甲上
- [ ] 装备恢复多层级结构(内层/中层/外层)
- [ ] 装备的叙事文本显示时变为灰色
- [ ] 装备菜单身体部位desc非空时改为“已装备:\n武装衣, 皮带”
- [ ] 武器的特殊伤害类型应该去掉。特殊攻击自己定义伤害而不是用武器的数值。例如头槌固定造成1点钝击伤害。

## 动作系统
- [x] 抓不应该播报伤害,但是要播报buff
- [x] 选择攻击方身体部位或防守方身体部位时,选项名应该带有装备.例如`右臂[护手][长剑]`
- [x] 身体部位选项的装备展示改为bbcode格式,例如躯干[icon=xxxx]
- [x] 新增抓和被抓的部位的行动
- [x] 为每个动作分配ID并为每个角色指定可用动作列表
- [x] 需要更详细的动作说明
- [x] 攻击动作区分前摇后摇,基类参数在动作类中填入
- [x] 行动菜单标题使用导航格式，例如`Ethan的回合`,`Ethan的左臂`,`Ethan的左臂斩击`,`Ethan的左臂斩击Dove的`
- [x] 行动的desc不要显示伤害倍率
- [x] 需要可以捡起地上的武器
- [x] 捡起武器的前后摇太短了，需要加长
- [x] 增加测试选项,处决.用手发动,选择敌人任意部位,直接让对应部位生命值归零
- [x] 放手动作目前无效果且会直接进入新回合,需要修复
- [x] 放手选项出现在多个部位,应仅在手臂出现
- [x] AI会选择没有东西可丢弃的部位进行丢弃。AI的可选列表不应该有被disable的项目，没有可丢弃物品时，应该被disable
- [ ] 放手，在手里有武器时，desc应该是"扔掉手里的武器",手上有抓buff时，"移除施加的束缚效果"
- [ ] 部位有抓住buff时除放手外行动变灰，束缚buff时除摆脱外行动变灰

## 反应系统
- [x] 每回合反应变为1
- [x] CharacterNode需要绘制反应
- [x] 即将遭受攻击时可以选择格挡,闪避,承受
- [x] 格挡消耗1个反应选择一个自己的ICombatTarget进行格挡
- [x] 闪避消耗1个反应进行闪避会打断自己的行动
- [x] 承受即什么也不做
- [x] 定义攻击动作的格挡成功率
- [x] 定义攻击动作的闪避成功率
- [x] 战斗开始时所有角色的反应点数应清零
- [x] 刺击应该更容易被闪避,更难被格挡
- [ ] 战斗开始时行动力计算有问题, 上前交涉还能先手, 待查
- [x] 裆部和躯干应该由格挡成功率加成
- [x] 反应会打断自己的动作
- [x] 玩家选择反应时,菜单的标题应该是"应对xxx对xxx的xxx",例如"应对贵族兵长剑对Ethan头部的斩击"
- [x] 玩家选择反应时,应该展示每个动作的格挡率和闪避率
- [x] 反应的结果不要显示成功率
- [ ] 反应点数不够时,选项应该变灰
- [x] AI应该有概率不反应
- [ ] 抓行动应更易被闪避且更易被格挡
- [ ] AI选择格挡动作时应避免用腿去格挡头部攻击
- [ ] ReactionOutcome移除Succeeded字段，使用BlockTarget标记格挡成功

## 音乐
- [x] 增加战斗bgm
- [x] 增加剧情bgm

## buff系统
- [x] 定义Buff类和BuffCode
- [x] 定义IBuffOwner接口
- [x] 装备实现IBuffOwner
- [x] 身体部位实现IBuffOwner
- [x] 实现抓住buff
- [ ] 角色任意部位被擒拿或束缚时，闪避和格挡成功率下降到1/3
- [ ] Buff列表中抓/束缚类buff增加desc描述，BuffCode扩展Desc { get; }
- [ ] 增加疼痛。用疼痛部位发起行动会提高需要消耗的行动力，闪避和格挡率更高。
- [ ] 增加流血。身体部位受到砍伤时必定造成流血，受到刺伤时50%造成流血。流血会每5tick随机部位生命值-1，身体任意部位有流血buff时，角色节点需要打开流血动画

## jucy
- [x] 人物受击时身体部位的血条闪一下红色
- [ ] 身体部位的血条要缓慢变化

## 存档
- [x] 游戏需要引用玩家方的角色对象而不是每次战斗重新创建
- [x] 游戏菜单增加存档选项
- [x] 主菜单开始新游戏需要选择一个存档槽
- [x] 主菜单增加读档选项
- [x] 存档槽显示snapshot
- [x] snapshot记录版本号和时间
- [x] 存档槽显示snapshot时间，desc显示版本号

# 最美角落

## 武器卡住

Ethan的短剑精准刺入了Dove胸甲缝隙!
Dove死了
Ethan的短剑卡在Dove的胸甲缝隙里拔不出来
Ethan尝试用力拔出短剑

## 武器断裂

Ethan的斩击
Dove用钉头锤挡住了Ethan的斩击
Ethan的长剑断了!

## 面罩

Ethan束缚住了Jack!
Dove掀开了Jack的面罩!
Dove用匕首刺进Jack的眼球!

## 流血

角色卡片有流血动画

# 悬而未决
