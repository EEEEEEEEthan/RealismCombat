# 状态机系统

游戏使用状态机管理游戏流程，不同状态下支持不同的指令集。

## 核心概念

- **IStateOwner**: 状态拥有者接口，提供状态属性
- **State**: 抽象状态基类，定义状态行为和可用指令
- **状态转换**: 通过修改owner的State属性实现

## 实现文件

- `Scripts/StateMachine/State.cs` - 状态机基础框架
- `Scripts/GameRoot.cs` - GameRoot实现IStateOwner，包含具体状态类

## 游戏状态

### PreparerState (准备状态)
游戏初始状态，用于战斗准备。

支持指令：
- `system_shutdown` - 关闭游戏
- `game_check_status` - 检查状态
- `game_start_combat` - 开始战斗（切换到CombatState）

### CombatState (战斗状态)
战斗进行中的状态。

支持指令：
- `system_shutdown` - 关闭游戏
- `game_check_status` - 检查状态

## 场景生命周期管理

游戏中的场景节点随状态转换而管理其生命周期。

### BattlePrepareScene
准备场景在PreparerState下创建并添加到场景树，当状态切换到CombatState时被销毁。

实现方式：
- `GameRoot.battlePrepareScene` - 持有场景引用
- `StartCombatCommand.Execute()` - 执行状态切换前调用`QueueFree()`销毁场景
- 使用`QueueFree()`而非`Free()`确保安全的延迟销毁

## 相关文件

- `Scripts/Commands/` - 指令实现目录
- `Scripts/BattlePrepareScene.cs` - 准备场景，按钮触发StartCombatCommand
- `Scripts/Commands/StartCombatCommand.cs` - 开始战斗指令，负责销毁准备场景

