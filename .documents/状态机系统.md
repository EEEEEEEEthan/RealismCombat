# 状态机系统

游戏使用状态机管理游戏流程，不同状态下支持不同的指令集。

## 核心概念

- **IStateOwner**: 状态拥有者接口，提供状态属性
- **State**: 抽象状态基类，定义状态行为和可用指令
- **状态转换**: 通过修改owner的State属性实现
- **状态层级**: `ProgramRoot` 拥有程序级状态（`MenuState`、`GameState`），`GameState` 拥有游戏级状态（`PrepareState`、`CombatState`）
- **状态与节点的双向引用**: 状态持有并管理节点的生命周期，节点持有状态引用以便访问上下文

## 逐帧 Update 驱动

- 调用链：`GameRoot._Process(delta)` → `GameRoot.State.Update(delta)` → （在 `CombatState` 中）`combat.Update(delta)` → `Combat.State.Update(delta)`。
- 目标：由 `IStateOwner` 驱动所有状态的逐帧逻辑，使状态内部可按需复写 `Update(dt)`。
- 涉及文件：
  - `Scripts/StateMachine/State.cs`（`State.Update(double dt)` 基类方法）
  - `Scripts/GameRoot.cs`（`_Process` 中调用 `State.Update`；`CombatState.Update` 驱动 `Combat`）
  - `Scripts/Combat.cs`（`Combat.Update` 转发到当前 `State`）

## 实现文件

- `Scripts/StateMachine/State.cs` - 状态机基础框架
- `Scripts/Nodes/ProgramRoot.cs` - 程序根节点，实现IStateOwner
- `Scripts/StateMachine/ProgramStates/` - 程序级状态（MenuState、GameState）
- `Scripts/StateMachine/GameStates/` - 游戏级状态（PrepareState、CombatState）

## 程序级状态

### MenuState (主菜单状态)
程序初始状态，显示主菜单。

### GameState (游戏状态)
游戏运行状态，持有 `Game` 节点，包含游戏级子状态。

## 游戏级状态

### PrepareState (准备状态)
游戏初始状态，用于战斗准备，创建并管理 `BattlePrepareScene`。

支持指令：
- `game_start_combat` - 开始战斗（切换到CombatState）

### CombatState (战斗状态)
战斗进行中的状态，创建并管理 `Combat` 节点。

- `CombatState` 持有 `Combat` 节点引用，在构造时创建并挂载节点，退出时销毁
- `Combat` 节点持有 `CombatState` 引用，可访问状态上下文
- 文件：`Scripts/StateMachine/GameStates/CombatState.cs`、`Scripts/Nodes/Combat.cs`

## 场景生命周期管理

游戏中的场景节点随状态转换而管理其生命周期：

- 状态在构造时创建并挂载节点到场景树
- 状态在 `OnExit()` 时调用节点的 `QueueFree()` 销毁节点
- 使用 `QueueFree()` 而非 `Free()` 确保安全的延迟销毁

### 示例
- `PrepareState` 管理 `BattlePrepareScene`
- `CombatState` 管理 `Combat` 节点
- `MenuState` 管理 `MainMenu` 节点
- `GameState` 管理 `Game` 节点

## 相关文件

- `Scripts/Commands/GameCommands/StartCombatCommand.cs` - 开始战斗指令，切换到CombatState
- `Scripts/BattlePrepareScene.cs` - 准备场景，按钮触发StartCombatCommand

