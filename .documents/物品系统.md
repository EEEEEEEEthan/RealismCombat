# 物品系统

## 概述
物品系统支持角色的装备管理和物品的嵌套存储。

## 核心概念

### IItemContainer 接口
所有可以存储物品的容器都实现 `IItemContainer` 接口，提供统一的物品管理接口。

**接口定义：**
- `IReadOnlyList<ItemData?> items` - 只读的物品列表，空槽为 `null`
- `event Action? ItemsChanged` - 物品变化时触发的事件

位于 `Scripts/Data/IItemContainer.cs`

### 物品容器实现

#### 身体部位物品槽
每个身体部位（头部、躯干、左臂、右臂、左腿、右腿）有多个物品槽，可以放置多个物品。

**槽位数量配置：**
- 左臂和右臂：2个槽位
- 其他部位（头部、躯干、左腿、右腿）：1个槽位
- 槽位数量由 `BodyPartCodeExtensions.GetSlotCapacity` 方法定义

**数据结构：**
- `BodyPartData` 实现 `IItemContainer` 接口
- `BodyPartData.slots` 是 `ItemData?[]` 类型数组
- 数组长度根据身体部位类型确定
- 数组元素可以为 `null`（空槽位）

位于 `Scripts/Data/CharacterData.cs` 的 `BodyPartData` 类

#### 物品内部物品槽
物品本身也可以有物品槽，用于存储其他物品。物品槽的数量由物品配置决定。

**物品槽容量配置：**
- 每个物品的物品槽容量在 `ItemConfig.slotCapacity` 中配置
- 物品槽数组长度始终等于配置的容量
- 槽位可以为空（`null`），表示该槽位未放置物品

**数据结构：**
- `ItemData` 实现 `IItemContainer` 接口
- `ItemData.slots` 是 `ItemData?[]` 类型数组
- 数组长度等于 `ItemConfig.slotCapacity`
- 数组元素可以为 `null`（空槽位）

位于 `Scripts/Data/ItemData.cs` 的 `ItemData` 类

### 装备菜单系统

装备菜单系统提供用户界面来管理角色的装备，统一处理所有 `IItemContainer` 的展开和管理。

#### 菜单层级结构
1. **角色选择菜单**：显示所有玩家角色，选择要管理装备的角色
2. **装备主菜单**：显示选中角色的所有身体部位，有装备的部位显示为"部位[物品1][物品2]"
3. **物品容器菜单**：统一的容器展开菜单，根据容器类型显示不同格式：
   - 身体部位容器：显示物品名（空槽显示"空"）
   - 物品容器：显示"物品名(已装备数/总容量)"（空槽显示"空"）
4. **空槽选择菜单**：点击空槽显示物品列表，选择物品进行装备
5. **卸下菜单**：当物品没有槽位或所有槽位为空时显示，用于卸下装备

#### 菜单显示规则

**角色选择菜单：**
- 显示所有玩家角色的名称
- 选择角色后进入该角色的装备主菜单

**装备主菜单：**
- 标题显示为"{角色名} - 装备"
- 无装备的部位：显示部位名（如"头部"）
- 有装备的部位：显示"部位[物品1][物品2]"（如"头部[测试装备]"）

**物品容器菜单：**
- 身体部位的容器：空槽显示"空"，有物品显示物品名
- 物品容器：空槽显示"空"，有物品显示"物品名(已装备数/总容量)"（如"背包(1/4)"）
- 如果物品没有槽位，直接显示物品名，不会显示数量

#### 自动刷新机制
所有菜单都会监听容器的 `ItemsChanged` 事件，当物品发生变化时会自动刷新菜单内容，无需手动返回。

#### 物品堆叠机制
- 当物品被卸下放回物品栏时，系统会检查是否存在相同类型的物品可以堆叠
- 堆叠条件：
  - 两个物品的 `itemId` 必须相同
  - 两个物品的 `slots` 数组长度必须相同
  - 两个物品的所有槽位都必须为空（`null`）
- 如果满足堆叠条件，物品的 `count` 会增加；否则作为新物品添加到物品栏
- 如果物品有非空槽位，无法堆叠，会作为独立物品添加

#### 卸下规则
- 只有当装备的所有槽位都为空时，才显示"卸下"按钮
- 如果装备存在非空槽位，不允许卸下（防止装备丢失）
- 卸下时会自动进行堆叠检查

#### 菜单显示规则
- 所有菜单中显示物品时使用物品名字（`ItemConfig.name`）而不是物品ID
- 如果物品ID未在配置中找到，则显示为"物品{ID}"

#### 递归嵌套
装备上的槽位可以继续装备其他物品，形成多层级嵌套结构。每个层级都遵循相同的菜单规则。

参考文件：
- `Scripts/Data/IItemContainer.cs` - 物品容器接口
- `Scripts/Data/ItemData.cs` - 物品数据和物品容器实现
- `Scripts/Data/CharacterData.cs` - 身体部位容器实现
- `Scripts/Nodes/GameNode.cs` - 装备菜单系统实现


