# 物品系统

## 概述
物品系统支持角色的装备管理和物品的嵌套存储。

## 核心概念

### IItemContainer 接口
所有可以存储物品的容器都实现 `IItemContainer` 接口，提供统一的物品管理接口。

**接口定义：**
- `IReadOnlyList<ItemData?> items` - 只读的物品列表，空槽为 `null`
- `event Action? ItemsChanged` - 物品变化时触发的事件

位于 `Scripts/Data/IItemContainer.cs`

### SlotData 槽位抽象层

每个槽位由 `SlotData` 类管理，包含槽位的允许装备类型和当前装备的物品。

**数据结构：**
- `allowedTypes` - 允许的装备类型（`EquipmentType` 标志位组合）
- `item` - 当前槽位中的物品（可为 `null`）

**装备验证：**
- `CanPlace(ItemData? item)` 方法检查物品是否可以放入槽位
- 使用位运算 `(allowedTypes & itemType) != 0` 判断物品类型是否有交集

位于 `Scripts/Data/ItemData.cs` 的 `SlotData` 类

### 物品容器实现

#### 身体部位物品槽
每个身体部位（头部、躯干、左臂、右臂、左腿、右腿）有多个物品槽，可以放置多个物品。

**槽位数量配置：**
- 左臂和右臂：2个槽位
- 其他部位（头部、躯干、左腿、右腿）：1个槽位
- 槽位数量由 `BodyPartCodeExtensions.GetSlotCapacity` 方法定义

**槽位类型限制：**
- 头部：只能装备头盔内衬（`HelmetLiner`）
- 躯干：只能装备胸甲内衬（`ChestLiner`）
- 左臂/右臂第一个槽位：只能装备护手（`Gauntlet`）
- 左臂/右臂第二个槽位：只能装备单手或双手武器（`OneHandedWeapon | TwoHandedWeapon`）
- 左腿/右腿：只能装备腿甲内衬（`LegLiner`）
- 槽位限制由 `BodyPartCodeExtensions.GetAllowedTypes(part, slotIndex)` 方法定义

**数据结构：**
- `BodyPartData` 实现 `IItemContainer` 接口
- `BodyPartData.slots` 是 `SlotData[]` 类型数组
- 数组长度根据身体部位类型确定
- 每个槽位都有独立的 `allowedTypes` 配置

位于 `Scripts/Data/CharacterData.cs` 的 `BodyPartData` 类

#### 物品内部物品槽
物品本身也可以有物品槽，用于存储其他物品。物品槽的数量由物品配置决定。

**物品槽容量配置：**
- 每个物品的物品槽容量在 `ItemConfig.slotCapacity` 中配置
- 物品槽数组长度始终等于配置的容量
- 槽位的允许装备类型可以通过两种方式配置：
  - 统一配置：使用 `ItemConfig.slotAllowedTypes` 为所有槽位设置相同的允许类型
  - 独立配置：使用 `ItemConfig.slotAllowedTypesPerSlot` 为每个槽位设置不同的允许类型
  - 如果设置了 `slotAllowedTypesPerSlot`，则使用 `GetSlotAllowedTypes(slotIndex)` 方法获取每个槽位的允许类型
  - 如果未设置 `slotAllowedTypesPerSlot`，则所有槽位使用 `slotAllowedTypes` 的配置

**数据结构：**
- `ItemData` 实现 `IItemContainer` 接口
- `ItemData.slots` 是 `SlotData[]` 类型数组
- 数组长度等于 `ItemConfig.slotCapacity`
- 每个槽位的 `allowedTypes` 配置可以不同（通过 `ItemConfig.GetSlotAllowedTypes` 方法获取）

位于 `Scripts/Data/ItemData.cs` 的 `ItemData` 类

#### 物品配置（ItemConfig）
每个物品都有一个配置信息，定义物品的基本属性。

**配置属性：**
- `itemId` - 物品唯一标识符
- `name` - 物品显示名称
- `slotCapacity` - 物品槽容量（物品可以存储的其他物品数量）
- `equipmentType` - 装备类型（`EquipmentType` 枚举值，支持位标志组合）
- `slotAllowedTypes` - 物品槽位允许的装备类型（`EquipmentType` 标志位组合，用于统一配置所有槽位）
- `slotAllowedTypesPerSlot` - 每个槽位独立的允许装备类型配置（可选，如果设置则覆盖统一配置）

**槽位类型配置方法：**
- `GetSlotAllowedTypes(int slotIndex)` - 获取指定槽位的允许装备类型
  - 如果设置了 `slotAllowedTypesPerSlot` 且索引有效，返回对应槽位的配置
  - 否则返回 `slotAllowedTypes` 的统一配置

**配置管理：**
- 所有物品配置存储在 `ItemConfig.Configs` 静态字典中
- 使用 `itemId` 作为键进行查找
- 配置在 `ItemConfig` 静态构造函数中初始化

位于 `Scripts/Data/ItemData.cs` 的 `ItemConfig` 类

### 装备类型枚举

装备类型使用 `EquipmentType` 枚举定义，支持位标志（Flags）组合，使用 `ulong` 类型。

**枚举定义：**
- `None` - 无类型
- `Money` - 货币类型
- `HelmetLiner`、`HelmetMidLayer`、`Helmet` - 头部防护装备
- `Gauntlet` - 手部防护装备
- `ChestLiner`、`ChestMidLayer`、`ChestOuter` - 躯干防护装备
- `LegLiner`、`LegMidLayer`、`LegOuter` - 腿部防护装备
- `OneHandedWeapon`、`TwoHandedWeapon` - 武器持握方式
- `Knife`、`Sword`、`Hammer`、`Axe`、`Spear`、`Halberd` - 武器类型
- `Shield` - 盾牌类型

**特性：**
- 使用 `[Flags]` 特性，支持位标志组合
- 使用 `ulong` 类型，支持最多64个不同的标志位
- 每个类型值都是2的幂次方，可以使用位运算组合多个类型
- 所有枚举值都有中文文档注释说明其用途
- 例如：`EquipmentType.OneHandedWeapon | EquipmentType.Knife` 表示单手刀

位于 `Scripts/Data/ItemData.cs` 的 `EquipmentType` 枚举

### 装备菜单系统

装备菜单系统提供用户界面来管理角色的装备，统一处理所有 `IItemContainer` 的展开和管理。

#### 菜单层级结构
1. **角色选择菜单**：显示所有玩家角色，选择要管理装备的角色
2. **装备主菜单**：显示选中角色的所有身体部位，有装备的部位显示为"部位[物品1][物品2]"
3. **物品容器菜单**：统一的容器展开菜单，根据容器类型显示不同格式：
   - 身体部位容器：显示物品名（空槽显示"空"）
   - 物品容器：显示"物品名(已装备数/总容量)"（空槽显示"空"）
4. **空槽选择菜单**：点击空槽显示物品列表，选择物品进行装备
   - 可装备的物品正常显示且可选
   - 不可装备的物品显示但禁用（灰色或不可点击），用户可以看到但不能选择
   - 使用 `SlotData.CanPlace` 方法判断物品是否可以放入槽位
5. **物品槽位菜单**：点击有槽位的物品时显示
   - 如果物品有槽位（无论是否全空），直接显示槽位菜单
   - 菜单显示所有槽位（空槽显示"空"，有物品显示物品名或"物品名(已装备数/总容量)"）
   - 如果物品是被装备在其他容器中的（有父容器），在槽位菜单底部显示"卸下"选项
   - 如果物品是身体部位的直接装备且没有槽位，显示单独的卸下菜单

#### 菜单显示规则

**角色选择菜单：**
- 显示所有玩家角色的名称
- 选择角色后进入该角色的装备主菜单

**装备主菜单：**
- 标题显示为"{角色名} - 装备"
- 无装备的部位：显示部位名（如"头部"）
- 有装备的部位：显示"部位[物品1][物品2]"（如"头部[测试装备]"）

**物品容器菜单：**
- 身体部位的容器：空槽显示"空"，有物品显示物品名
- 物品容器：空槽显示"空"，有物品显示"物品名(已装备数/总容量)"（如"背包(1/4)"）
- 如果物品没有槽位，直接显示物品名，不会显示数量

#### 自动刷新机制
所有菜单都会监听容器的 `ItemsChanged` 事件，当物品发生变化时会自动刷新菜单内容，无需手动返回。

#### 物品堆叠机制
- 当物品被卸下放回物品栏时，系统会检查是否存在相同类型的物品可以堆叠
- 堆叠条件：
  - 两个物品的 `itemId` 必须相同
  - 两个物品的 `slots` 数组长度必须相同
  - 两个物品的所有槽位都必须为空（`slot.item == null`）
- 如果满足堆叠条件，物品的 `count` 会增加；否则作为新物品添加到物品栏
- 如果物品有非空槽位，无法堆叠，会作为独立物品添加

#### 卸下规则
- 有槽位的物品：在槽位菜单底部显示"卸下"选项（无论槽位是否全空）
- 无槽位的物品：点击时显示单独的卸下菜单
- 卸下时会自动进行堆叠检查

#### 菜单显示规则
- 所有菜单中显示物品时使用物品名字（`ItemConfig.name`）而不是物品ID
- 如果物品ID未在配置中找到，则显示为"物品{ID}"

#### 递归嵌套
装备上的槽位可以继续装备其他物品，形成多层级嵌套结构。每个层级都遵循相同的菜单规则。

## 装备验证机制

### 装备类型验证
- 在 `SetSlot` 方法中，会调用 `SlotData.CanPlace` 方法验证物品是否可以放入槽位
- 如果验证失败，会抛出 `InvalidOperationException` 异常
- 使用位运算 `(allowedTypes & itemType) != 0` 判断物品类型是否有交集

### 物品选择菜单验证
- 在显示物品选择菜单时，会预先检查每个物品是否可以放入当前槽位
- 不可装备的物品会显示但禁用，用户可以看到但不能选择
- 这提供了更好的用户体验，用户可以清楚知道哪些物品不能装备

参考文件：
- `Scripts/Data/IItemContainer.cs` - 物品容器接口
- `Scripts/Data/ItemData.cs` - 物品数据、物品容器实现和 SlotData 抽象层
- `Scripts/Data/CharacterData.cs` - 身体部位容器实现
- `Scripts/Nodes/GameNode.cs` - 装备菜单系统实现


