# MCP服务器设计

## 目录

- [概述](#概述)
- [架构](#架构)
- [启动流程](#启动流程)
- [工具类](#工具类)

## 概述

游戏通过MCP(Model Context Protocol)服务器进行外部控制和自动化测试。

## 架构

### MCP客户端
MCP客户端是外部工具，通过MCP协议与游戏通信：
- 负责启动游戏进程
- 分配和管理端口
- 通过TCP连接与游戏通信
- 提供MCP工具接口供AI使用

### 游戏端服务器 (Scripts/)
- GameServer：TCP服务器，监听指定端口
- 接收客户端命令并返回响应
- 通过事件和回调将命令发送到主线程处理
- 支持指令挂起：同一时间只处理一个指令，多余指令返回"正忙"
- 自动收集指令处理期间的日志并随响应返回

### 程序入口 (Scripts/Nodes/)
- ProgramRootNode：游戏主入口节点
- 从命令行参数读取`--port=xxx`
- 初始化GameServer
- 在主线程中处理命令（通过并发队列）
- 客户端断开时自动退出

## 启动流程

1. MCP客户端分配空闲端口
2. 启动Godot进程并传递 `--port=xxx` 参数
3. 游戏启动TCP服务器监听该端口
4. MCP客户端连接到游戏
5. 双向通信建立完成

## 工具类

### Log
统一的日志输出接口，封装GD.Print系列方法：
- 自动添加时间戳 `[HH:mm:ss]`
- 提供三个事件：OnLog、OnLogError、OnLogWarning
- 支持通过事件订阅日志输出

### LogListener
日志收集器，用于收集一段时间内的日志：
- 通过订阅Log事件收集日志
- 线程安全的日志收集和读取
- 自动添加日志级别标记（ERROR、WARN）

### Settings
配置管理，从`.local.settings`文件读取配置（格式：`key = value`）。

