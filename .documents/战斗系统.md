# 战斗系统

## 概述
战斗系统采用回合制，通过行动力系统控制角色行动顺序。战斗行动在执行前必须通过模拟验证。

## 核心概念

### 行动模拟验证
位于 `Scripts/Nodes/CombatNode.cs` 的 `ActionSimulate` 类

**职责：**
- 在执行战斗行动前验证行动的有效性
- 计算行动造成的伤害和消耗的行动力
- 检查攻击者、防御者、身体部位的有效性

**验证规则：**
- 攻击者身体部位必须可用（HP > 0）
- 防御者必须是敌方且存活
  - 不能攻击自己
  - 不能攻击同队队友
  - 防御者必须存活（未死亡）
- 防御者身体部位必须可用（HP > 0）

**返回结果：**
- `SimulateResult` 包含伤害范围（元组 `(int min, int max)`）和行动力消耗值
- 战斗执行时从伤害范围内随机取值，确保每次攻击的伤害都在预期范围内

### 战斗状态机
战斗节点使用状态机管理战斗流程：
- `RoundInProgressState` - 回合进行中，恢复行动力
- `CharacterTurnState` - 角色回合，玩家选择行动或AI自动行动
- `CharacterTurnActionState` - 执行行动，包含模拟验证和执行逻辑

### 玩家战斗菜单
玩家回合时，通过多层菜单选择行动：

**菜单结构：**
1. **选择攻击者身体部位** - 第一层菜单，选择用于攻击的身体部位
2. **选择目标角色** - 第二层菜单（子菜单），选择攻击目标
   - 有返回按钮，可返回到选择身体部位菜单
3. **选择目标身体部位** - 第三层菜单（子菜单），选择攻击目标的身体部位
   - 有返回按钮，可返回到选择目标角色菜单
   - 确认后执行攻击并删除所有菜单

**设计特点：**
- 采用母子菜单结构，打开子菜单时父菜单保留
- 每个子菜单都有返回按钮，支持返回上一级菜单
- 完成行动后统一删除所有相关菜单
- 允许玩家在不丢失之前选择的情况下返回修改

参考文件：
- `Scripts/Nodes/CombatNode.cs`

