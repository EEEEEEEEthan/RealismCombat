# 战斗系统

## 概述
战斗系统采用回合制，通过行动力系统控制角色行动顺序。战斗行动在执行前必须通过模拟验证。

## 玩家角色管理

### 玩家角色列表
游戏数据（`GameData`）维护一个玩家角色列表（`playerCharacters`），用于存储玩家的角色数据。

**设计要点：**
- 玩家角色列表独立于战斗数据，用于持久化玩家角色状态
- 装备系统操作的是玩家角色列表中的角色，支持多角色管理
- 开始战斗时，系统会直接引用玩家角色列表中的所有角色添加到战斗数据中
- 战斗中对角色的修改会直接影响玩家角色列表中的原始数据
- 支持多个玩家角色，装备菜单可以选择任意角色进行装备管理

## 核心概念

### 攻击动作类型
位于 `Scripts/Data/ActionData.cs` 的 `ActionCode` 枚举

**定义：**
定义了可用的攻击动作类型，用于描述角色的肢体攻击方式：
- 冲拳（StraightPunch）
- 勾拳（HookPunch）
- 挥砍（Swing）
- 刺击（Thrust）
- 踢（Kick）
- 肘击（ElbowStrike）
- 头槌（Headbutt）
- 冲撞（Charge）

**扩展方法：**
- `ActionCodeExtensions.GetName()` - 获取动作类型的中文名称

**在战斗数据中的使用：**
- `ActionData` 包含 `actionCode` 字段，记录每个攻击动作的类型
- 玩家回合时需要在选择身体部位后选择攻击动作类型

### 伤害类型
位于 `Scripts/Data/DamageType.cs` 的 `DamageType` 枚举

**定义：**
定义了战斗中的伤害类型，用于区分不同的物理伤害机制：
- 钝击（Blunt）- 由锤子等钝器造成的冲击伤害
- 劈砍（Slash）- 由刀剑等武器的劈砍动作造成的伤害
- 穿刺（Pierce）- 由枪、箭等尖锐武器刺入造成的伤害

**设计要点：**
- 使用 `[Flags]` 特性，支持组合多种伤害类型
- 使用 `byte` 类型节省内存
- 预留用于后续实现护甲防护、伤害计算等系统

### 动作配置系统
位于 `Scripts/Data/ActionData.cs` 的 `ActionConfig` 类

**定义：**
为每个攻击动作类型提供配置数据，包括：
- **伤害范围**：该动作造成的伤害范围（最小值，最大值）
- **行动力消耗**：执行该动作消耗的行动力
- **允许的身体部位**：该动作可以由哪些身体部位执行

**装备验证：**
- 每个动作配置提供 `ValidEquipment` 方法，验证角色是否具备执行该动作所需的装备
- 方法接受角色数据和身体部位，返回验证结果和错误信息
- 部分动作需要特定装备（如挥砍和刺击需要武器），未装备时验证失败
- 验证逻辑由动作配置自身定义，支持未来扩展为更复杂的验证规则（如特定动作需要特定武器类型）

**设计要点：**
- 使用静态字典 `Configs` 存储所有动作配置
- 每个动作配置在静态构造函数中初始化
- 参考 `ItemConfig` 的设计模式，提供统一的数据配置管理
- 装备验证逻辑封装在配置类中，便于扩展和维护

**配置示例：**
- 冲拳/勾拳/挥砍/刺击/肘击：限定在左臂或右臂使用
- 踢：限定在左腿或右腿使用
- 头槌：限定在头部使用
- 冲撞：限定在躯干使用
- 挥砍/刺击：需要手臂装备武器

**在战斗中的使用：**
- 行动模拟验证时根据配置计算伤害和行动力消耗
- 选择攻击动作时根据身体部位和装备情况过滤可用动作
- 不符合身体部位要求的动作不显示在菜单中（被隐藏）
- 不符合装备要求的动作显示但禁用，显示具体错误信息（如"右臂未装备武器"）

### 行动模拟验证
位于 `Scripts/Nodes/CombatNode.cs` 的 `ActionSimulate` 类

**职责：**
- 在执行战斗行动前验证行动的有效性
- 计算行动造成的伤害和消耗的行动力
- 检查攻击者、防御者、身体部位的有效性

**验证规则：**
- 攻击者身体部位必须可用（HP > 0）
- 防御者必须是敌方且存活
  - 不能攻击自己
  - 不能攻击同队队友
  - 防御者必须存活（未死亡）
- 防御者身体部位必须可用（HP > 0）
- 攻击者必须具备执行该动作所需的装备（通过 `ActionConfig.ValidEquipment` 验证）

**返回结果：**
- `SimulateResult` 包含伤害范围（元组 `(int min, int max)`）和行动力消耗值
- 战斗执行时从伤害范围内随机取值，确保每次攻击的伤害都在预期范围内

### 反应点防御机制
位于 `Scripts/Nodes/CombatNode.cs` 的 `CharacterTurnActionState`

**反应点获得：**
- 每个角色回合开始时（行动力恢复至0或以上时），自动获得1点反应点
- 反应点可以累积，没有上限
- 位于 `RoundInProgressState.CheckForReadyCharacter()` 中处理

**触发条件：** 防御者为玩家控制角色。

**玩家选项：**
- **格挡**：消耗1点反应，可以选择任意可用身体部位进行格挡，受击部位免伤，格挡部位受到原伤害的一半。没有反应点时不可选，显示"需要1个[反应]"。
- **闪避**：消耗1点反应，根据攻击武器和防御者负重动态计算成功率，成功则完全闪避；失败则照常结算伤害。没有反应点时不可选，显示"需要1个[反应]"。
- **硬抗**：不消耗反应点，直接承受攻击。始终可用。

**流程要点：** 菜单交互在行动结算前完成，成功免伤依旧会结算攻击者的行动力消耗并继续回合推进。

**UI显示：**
- 角色节点（`CharacterNode`）的 `ReactionContainer` 中动态显示与反应点数量相等的 `Reaction.tscn` 实例
- 在 `_Process()` 中每帧同步反应点数量与UI显示，确保视觉反馈准确
- 闪避选项显示实际计算的成功率百分比（如"25%概率闪避"）

### 反应模拟计算
位于 `Scripts/Data/ReactionSimulate.cs`

**职责：**
- 计算各种反应的成功率和效果
- 根据攻击者装备、防御者负重等因素动态计算

**闪避成功率计算：**
- 公式：`闪避成功率 = 武器重量 / 武器长度 / 防御者身体重量`
- 武器重量和长度从攻击者使用的武器物品中获取
- 防御者身体重量 = 基础体重（70kg）+ 所有装备物品的总重量
- 对于非武器攻击（拳击、踢腿等），返回默认50%成功率
- 结果限制在0-100%之间

**格挡伤害减免：**
- 当前固定为50%（原伤害的一半）
- 预留方法供未来扩展

### 战斗状态机
战斗节点使用状态机管理战斗流程：
- `RoundInProgressState` - 回合进行中，恢复行动力
- `CharacterTurnState` - 角色回合，玩家选择行动或AI自动行动
- `CharacterTurnActionState` - 执行行动，包含模拟验证和执行逻辑

### 玩家战斗菜单
玩家回合时，通过多层菜单选择行动：

**菜单结构：**
1. **选择攻击者身体部位** - 第一层菜单，选择用于攻击的身体部位
2. **选择攻击动作** - 第二层菜单（子菜单），选择攻击动作类型（ActionCode）
   - 根据身体部位和装备情况过滤可用动作
   - 不符合身体部位要求的动作不显示（被隐藏）
   - 符合身体部位但不符合装备要求的动作显示但禁用，显示错误信息（如"右臂未装备武器"）
   - 有返回按钮，可返回到选择身体部位菜单
3. **选择目标角色** - 第三层菜单（子菜单），选择攻击目标
   - 有返回按钮，可返回到选择攻击动作菜单
4. **选择目标身体部位** - 第四层菜单（子菜单），选择攻击目标的身体部位
   - 有返回按钮，可返回到选择目标角色菜单
   - 确认后执行攻击并删除所有菜单

**设计特点：**
- 采用母子菜单结构，打开子菜单时父菜单保留
- 每个子菜单都有返回按钮，支持返回上一级菜单
- 完成行动后统一删除所有相关菜单
- 允许玩家在不丢失之前选择的情况下返回修改

### AI战斗行为
位于 `Scripts/Nodes/CombatNode.cs` 的 `HandleBotTurn` 和 `DecideBotReaction` 方法

**进攻决策流程：**
AI回合时自动执行以下随机决策：
1. **随机选择目标敌人** - 从所有有效敌人中随机选择一个攻击目标
2. **随机选择攻击身体部位** - 从AI角色所有可用身体部位（HP > 0）中随机选择
3. **随机选择攻击动作** - 根据选定的身体部位和装备，从所有可用动作中随机选择
4. **随机选择目标身体部位** - 从目标角色的所有有效身体部位中随机选择

**防御决策流程：**
AI被攻击时，根据闪避成功率智能选择反应方式：
1. **闪避成功率 ≥ 60%** - 优先选择闪避
2. **闪避成功率 30%-60%** - 50%概率闪避，50%概率格挡（随机）
3. **闪避成功率 < 30%** - 优先选择格挡，从所有可用身体部位中随机选择格挡部位
4. **没有反应点** - 硬抗
5. **没有可用格挡部位** - 尝试闪避

**设计要点：**
- 所有选择都通过 `ActionSimulate` 进行验证，确保行动有效
- 使用 `GD.RandRange()` 实现随机选择，增加战斗多样性
- 遵循与玩家相同的行动验证规则（身体部位可用性、装备要求等）
- AI反应决策会根据 `ReactionSimulate.CalculateDodgeSuccessRate()` 计算的闪避成功率做出合理判断
- 所有AI决策都会输出日志，便于调试和理解AI行为
- 如果没有可用选项会抛出异常提示

参考文件：
- `Scripts/Nodes/CombatNode.cs`

